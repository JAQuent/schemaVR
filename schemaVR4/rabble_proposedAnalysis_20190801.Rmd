---
title: "Proposed analysis"
author: "Jörn Alexander Quent"
date: "1 August 2019"
output: ioslides_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE, 
                      message = FALSE)

# Libraries
library(knitr)
library(ggplot2)
library(brms)
library(assortedRFunctions)
library(cowplot)
theme_set(theme_grey())

# General settings
options(scipen = 10)

# Plot settings
cbPalette     <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
kitchenColour <- c(cbPalette[2], cbPalette[3])
expColour     <- cbPalette[5:8]
mrcColour     <- '#77685C' # MRC colour 77685C
axisText      <- 10
legendText    <- 15
annotateSize  <- 5
```

# Background

## Savage-Dickey density ratio
- One way of calculating BF for point hypotheses is the Savage-Dickey density ratio (see Wagenmakers et al., 2010).
- For testing whether a parameter is zero:
$$ BF_{01} = \frac{p(D|H_{0})}{p(D|H_{1})} = \frac{p(\theta = 0|D,H_{0})}{p(\theta = 0|D,H_{1})}$$


## Savage-Dickey density ratio
```{r, echo = FALSE, fig.height = 4, fig.align = 'center'}
load("U:/Projects/schemaVR/schemaVR4/bayesianMM_recall_twolines_20190730_110220.RData")
shift          <- 0.5
sharpen        <- 1.59893
postDenMean1  <- schemaVR2_recall_twolines_fixef[3,1] - shift
postDenMean2  <- schemaVR2_recall_twolines_fixef[3,1]
postDenMean3  <- schemaVR2_recall_twolines_fixef[3,1] + shift
postDenSD     <- schemaVR2_recall_twolines_fixef[3,2]/sharpen


```

## Savage-Dickey density ratio
$$ BF_{01} = \frac{p(D|H_{0})}{p(D|H_{1})} = \frac{p(\theta = 0|D,H_{0})}{p(\theta = 0|D,H_{1})}$$
$$ BF_{01} = \frac{0.003547}{0.00064} = 5.542187$$
$$ BF_{10} = 1/5.542187 = 0.1804342$$

## Savage-Dickey density ratio
```{r}
kable(exampleBF)
```

## Savage-Dickey density ratio r
```{r eval = FALSE, echo = TRUE}
library(brms)

model_priors <- c(set_prior("normal(0.75,1)",
                            class = "Intercept"),
                  set_prior("normal(0,1)",
                            class = "b",
                            coef = "x"))
model <- brm(y ~  x,
             data = data,
             prior = model_priors,
             save_all_pars = TRUE,
             sample_prior = TRUE)

hypothesis(model, "x = 0")
```

## Savage-Dickey density ratio r
If you are unsure for which parameters you need priors, use this: 
```{r eval = FALSE, echo = TRUE}
get_prior(y ~  x,
          data = data)
```

# Previous results
## U-shape quadratic term
```{r, echo = FALSE, fig.height = 2.5, fig.align = 'center'}
# Loading data
load("U:/Projects/schemaVR/schemaVR4/findingAnalysis_20190729_190414.RData")

# Scatterplots
# Plot 1
# Limits
xlims    <- c(-1.63, 1.43)
ylimsAcc <- c(-0.039, 1.039)
yLimsEuc <- c(-0.02, 6)
x        <- seq(xlims[1], xlims[2], 0.01)

# Extract line fits from Bayesian analysis
nDraws      <- dim(schemaVR1_recall_postDen)[1]
xMatrix     <- matrix(rep(x, each = nDraws), nrow = nDraws) 
drawnFit    <- schemaVR1_recall_postDen[, 1] + schemaVR1_recall_postDen[, 2]*xMatrix + schemaVR1_recall_postDen[, 3]*xMatrix*xMatrix
drawnFit_DF <- data.frame(id = rep(1:nDraws), x  = rep(x, each = nDraws), logitFit= c(drawnFit))
drawnFit_DF$fit <- logit2prob(drawnFit_DF$logitFit)

# Get mean fit
meanFit        <- fixef(schemaVR1_recall)[1, 1] + fixef(schemaVR1_recall)[2,1]*x + fixef(schemaVR1_recall)[3,1]*x*x
meanFit_DF     <- data.frame(x = x,logitFit = meanFit)
meanFit_DF$fit <- logit2prob(meanFit_DF$logitFit)

# Plot
schemaVR1_plot1 <- ggplot(dataSchemaVR1_recall, aes(x = objLocTargetRating, y = accRecall)) + 
  geom_point(position = position_jitter(height = 0.03, 
                                        width = 0), 
             alpha = 0.5)  +
  geom_line(data = drawnFit_DF, aes(x = x, y = fit, group = id), alpha = .01) +
  geom_line(data = meanFit_DF, aes(x = x, y = fit)) +
  labs(y = 'Pr (recall accuracy)',
       x = "Expectancy",
       title = 'schemaVR1') +
  coord_cartesian(ylim = c(ylimsAcc[1],
                           ylimsAcc[2]),
                  xlim = c(xlims[1],
                           xlims[2]),
                  expand = FALSE) + 
  theme(plot.margin = unit(c(1,1,1,1), "lines"),
        legend.position = 'none',
        axis.title = element_text(size = axisText)) 

# Extract line fits from Bayesian analysis
nDraws      <- dim(schemaVR2_recall_postDen)[1]
xMatrix     <- matrix(rep(x, each = nDraws), nrow = nDraws) 
drawnFit    <- schemaVR2_recall_postDen[, 1] + schemaVR2_recall_postDen[, 2]*xMatrix + schemaVR2_recall_postDen[, 3]*xMatrix*xMatrix
drawnFit_DF <- data.frame(id = rep(1:nDraws), x  = rep(x, each = nDraws), logitFit= c(drawnFit))
drawnFit_DF$fit <- logit2prob(drawnFit_DF$logitFit)

# Get mean fit
meanFit        <- fixef(schemaVR2_recall)[1, 1] + fixef(schemaVR2_recall)[2,1]*x + fixef(schemaVR2_recall)[3,1]*x*x
meanFit_DF     <- data.frame(x = x,logitFit = meanFit)
meanFit_DF$fit <- logit2prob(meanFit_DF$logitFit)

# Plot
schemaVR2_plot1 <- ggplot(dataSchemaVR2_recall, aes(x = objLocTargetRating, y = accRecall)) + 
  geom_point(position = position_jitter(height = 0.03, 
                                        width = 0), 
             alpha = 0.5)  +
  geom_line(data = drawnFit_DF, aes(x = x, y = fit, group = id), alpha = .01) +
  geom_line(data = meanFit_DF, aes(x = x, y = fit)) +
  labs(y = 'Pr (recall accuracy)',
       x = "Expectancy",
       title = 'schemaVR2') +
  coord_cartesian(ylim = c(ylimsAcc[1],
                           ylimsAcc[2]),
                  xlim = c(xlims[1],
                           xlims[2]),
                  expand = FALSE) + 
  theme(plot.margin = unit(c(1,1,1,1), "lines"),
        legend.position = 'none',
        axis.title = element_text(size = axisText)) 

xlims    <- c(-1.53, 1.43)
ylimsAcc <- c(-0.039, 1.039)
yLimsEuc <- c(-0.02, 6)
x        <- seq(xlims[1], xlims[2], 0.01)

# Scatterplots
# Plot 1
# Extract line fits from Bayesian analysis
nDraws      <- dim(schemaVR3_recall_postDen)[1]
xMatrix     <- matrix(rep(x, each = nDraws), nrow = nDraws) 
drawnFit    <- schemaVR3_recall_postDen[, 1] + schemaVR3_recall_postDen[, 2]*xMatrix + schemaVR3_recall_postDen[, 3]*xMatrix*xMatrix
drawnFit_DF <- data.frame(id = rep(1:nDraws), x  = rep(x, each = nDraws), logitFit= c(drawnFit))
drawnFit_DF$fit <- logit2prob(drawnFit_DF$logitFit)

# Get mean fit
meanFit        <- fixef(schemaVR3_recall)[1, 1] + fixef(schemaVR3_recall)[2,1]*x + fixef(schemaVR3_recall)[3,1]*x*x
meanFit_DF     <- data.frame(x = x,logitFit = meanFit)
meanFit_DF$fit <- logit2prob(meanFit_DF$logitFit)

# Plot
schemaVR3_plot1 <- ggplot(dataSchemaVR3_recall, aes(x = objLocTargetRating, y = accRecall)) + 
  geom_point(position = position_jitter(height = 0.03, 
                                        width = 0), 
             alpha = 0.5)  +
  geom_line(data = drawnFit_DF, aes(x = x, y = fit, group = id), alpha = .01) +
  geom_line(data = meanFit_DF, aes(x = x, y = fit)) +
  labs(y = 'Pr (recall accuracy)',
       x = "Expectancy",
       title = 'schemaVR3') +
  coord_cartesian(ylim = c(ylimsAcc[1],
                           ylimsAcc[2]),
                  xlim = c(xlims[1],
                           xlims[2]),
                  expand = FALSE) + 
  theme(plot.margin = unit(c(1,1,1,1), "lines"),
        legend.position = 'none',
        axis.title = element_text(size = axisText)) 

plot_grid(schemaVR3_plot1, schemaVR2_plot1, schemaVR3_plot1, ncol = 3)
```

## Case 1
Results similar to this experiment:
```{r}
kable(summary(schemaVR2_recall_lmer)$coefficients)
```

## Case 1
```{r, fig.align = 'center'}
nDraws      <- dim(recall_case1_postDen)[1]
xMatrix     <- matrix(rep(x, each = nDraws), nrow = nDraws) 
drawnFit    <- recall_case1_postDen[, 1] + recall_case1_postDen[, 2]*xMatrix + recall_case1_postDen[, 3]*xMatrix*xMatrix
drawnFit_DF <- data.frame(id = rep(1:nDraws), x  = rep(x, each = nDraws), logitFit= c(drawnFit))
drawnFit_DF$fit <- logit2prob(drawnFit_DF$logitFit)

# Get mean fit
meanFit        <- fixef(recall_case1_model)[1, 1] + fixef(recall_case1_model)[2,1]*x + fixef(schemaVR3_recall)[3,1]*x*x
meanFit_DF     <- data.frame(x = x,logitFit = meanFit)
meanFit_DF$fit <- logit2prob(meanFit_DF$logitFit)

# Plot
ggplot(recall_case1_data, aes(x = objLocTargetRating, y = accRecall)) + 
  geom_point(position = position_jitter(height = 0.03, 
                                        width = 0), 
             alpha = 0.5)  +
  geom_line(data = drawnFit_DF, aes(x = x, y = fit, group = id), alpha = .01) +
  geom_line(data = meanFit_DF, aes(x = x, y = fit)) +
  labs(y = 'Pr (recall accuracy)',
       x = "Expectancy") +
  coord_cartesian(ylim = c(ylimsAcc[1],
                           ylimsAcc[2]),
                  xlim = c(xlims[1],
                           xlims[2]),
                  expand = FALSE) +
  theme(plot.margin = unit(c(1,1,1,1), "lines"),
        legend.position = 'none',
        axis.title = element_text(size = axisText)) 
```

## Case 1
```{r, fig.align = 'center'}
####################################
# Plot posterior distributions
# Recall accuracy
# Extracting values
Experiment <- c(rep(' Exp 1',length(schemaVR1_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)),
                rep(' Exp 2',length(schemaVR2_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)),
                rep(' Exp 3',length(schemaVR3_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)),
                rep(' Case 1',length(recall_case1_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)))
Values     <- c(schemaVR1_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating,
                schemaVR2_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating,
                schemaVR3_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating,
                recall_case1_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)
postDen_recall_quad_eff <- data.frame(Experiment = Experiment,
                                      values = Values)

# Get values for lines
yMax                     <- max(density(recall_case1_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)$y)
recall_case1_effM_CI     <- as.numeric(recall_case1_fixef[3,3:4])

# Plot
ggplot(postDen_recall_quad_eff, aes(x = values, fill = Experiment)) + 
  geom_vline(xintercept = c(0), linetype ="dotted", size = 1) +
  geom_density(alpha = 0.5) + 
  geom_segment(x = recall_case1_effM_CI[1],
               y = 0,
               xend = recall_case1_effM_CI[1],
               yend = yMax,
               colour = 'black') +
  geom_segment(x = recall_case1_effM_CI[2],
               y = 0,
               xend = recall_case1_effM_CI[2],
               yend = yMax,
               colour = 'black') +
  geom_segment(x = recall_case1_effM_CI[1],
               y = yMax*1.065,
               xend = recall_case1_effM_CI[2],
               yend = yMax*1.065,
               colour = 'black',
               arrow = arrow(ends = "both", length = unit(0.2, "cm"))) +
  annotate("text", x = mean(recall_case1_effM_CI), y = yMax*1.1, label = "95 % CI") +
  coord_cartesian(ylim = c(0, yMax*1.3), expand = FALSE) +
  labs(y = 'Density',
       x = 'Quadratic term') +
  scale_fill_manual(values = expColour) +
  theme(plot.margin = unit(c(1,1,1,1), "lines"),
        legend.position = c(1, 1),
        legend.justification = c(1, 1),
        legend.key.size = unit(0.5, "cm"),
        legend.title = element_blank(),
        axis.title = element_text(size = axisText),
        legend.text = element_text(size = legendText))
```
       
## Case 2
- Quadratic term = 0.

## Case 2
```{r, fig.align = 'center'}
nDraws      <- dim(recall_case2_postDen)[1]
xMatrix     <- matrix(rep(x, each = nDraws), nrow = nDraws) 
drawnFit    <- recall_case2_postDen[, 1] + recall_case2_postDen[, 2]*xMatrix + recall_case2_postDen[, 3]*xMatrix*xMatrix
drawnFit_DF <- data.frame(id = rep(1:nDraws), x  = rep(x, each = nDraws), logitFit= c(drawnFit))
drawnFit_DF$fit <- logit2prob(drawnFit_DF$logitFit)

# Get mean fit
meanFit        <- fixef(recall_case2_model)[1, 1] + fixef(recall_case2_model)[2,1]*x + fixef(recall_case2_model)[3,1]*x*x
meanFit_DF     <- data.frame(x = x,logitFit = meanFit)
meanFit_DF$fit <- logit2prob(meanFit_DF$logitFit)

# Plot
ggplot(recall_case2_data, aes(x = objLocTargetRating, y = accRecall)) + 
  geom_point(position = position_jitter(height = 0.03, 
                                        width = 0), 
             alpha = 0.5)  +
  geom_line(data = drawnFit_DF, aes(x = x, y = fit, group = id), alpha = .01) +
  geom_line(data = meanFit_DF, aes(x = x, y = fit)) +
  labs(y = 'Pr (recall accuracy)',
       x = "Expectancy") +
  coord_cartesian(ylim = c(ylimsAcc[1],
                           ylimsAcc[2]),
                  xlim = c(xlims[1],
                           xlims[2]),
                  expand = FALSE) +
  theme(plot.margin = unit(c(1,1,1,1), "lines"),
        legend.position = 'none',
        axis.title = element_text(size = axisText)) 
```

## Case 2
```{r, fig.align = 'center'}
####################################
# Plot posterior distributions
# Recall accuracy
# Extracting values
Experiment <- c(rep(' Exp 1',length(schemaVR1_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)),
                rep(' Exp 2',length(schemaVR2_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)),
                rep(' Exp 3',length(schemaVR3_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)),
                rep(' Case 2',length(recall_case2_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)))
Values     <- c(schemaVR1_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating,
                schemaVR2_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating,
                schemaVR3_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating,
                recall_case2_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)
postDen_recall_quad_eff <- data.frame(Experiment = Experiment,
                                      values = Values)

# Get values for lines
yMax                     <- max(density(recall_case2_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)$y)
recall_case2_effM_CI     <- as.numeric(recall_case2_fixef[3,3:4])

# Plot
ggplot(postDen_recall_quad_eff, aes(x = values, fill = Experiment)) + 
  geom_vline(xintercept = c(0), linetype ="dotted", size = 1) +
  geom_density(alpha = 0.5) + 
  geom_segment(x = recall_case2_effM_CI[1],
               y = 0,
               xend = recall_case2_effM_CI[1],
               yend = yMax,
               colour = 'black') +
  geom_segment(x = recall_case2_effM_CI[2],
               y = 0,
               xend = recall_case2_effM_CI[2],
               yend = yMax,
               colour = 'black') +
  geom_segment(x = recall_case2_effM_CI[1],
               y = yMax*1.065,
               xend = recall_case2_effM_CI[2],
               yend = yMax*1.065,
               colour = 'black',
               arrow = arrow(ends = "both", length = unit(0.2, "cm"))) +
  annotate("text", x = mean(recall_case2_effM_CI), y = yMax*1.1, label = "95 % CI") +
  coord_cartesian(ylim = c(0, yMax*1.3), expand = FALSE) +
  labs(y = 'Density',
       x = 'Quadratic term') +
  scale_fill_manual(values = expColour) +
  theme(plot.margin = unit(c(1,1,1,1), "lines"),
        legend.position = c(1, 1),
        legend.justification = c(1, 1),
        legend.key.size = unit(0.5, "cm"),
        legend.title = element_blank(),
        axis.title = element_text(size = axisText),
        legend.text = element_text(size = legendText))
```

## Bayes factors
```{r, echo = TRUE}
hypothesis(recall_case1_model, "IobjLocTargetRatingMUobjLocTargetRating = 0")
```

## Bayes factors
```{r, echo = TRUE}
hypothesis(recall_case2_model, "IobjLocTargetRatingMUobjLocTargetRating = 0")
```

## Literature
Wagenmakers, E.-J., Lodewyckx, T., Kuriyal, H., & Grasman, R. (2010). Bayesian hypothesis testing for psychologists: A tutorial on the Savage–Dickey method. Cognitive Psychology, 60(3), 158–189. https://doi.org/https://doi.org/10.1016/j.cogpsych.2009.12.001