---
title: "Finding the right analysis for schemaVR4"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE, 
                      message = FALSE)

library(knitr)
library(ggplot2)
library(brms)
library(assortedRFunctions)
library(cowplot)
theme_set(theme_grey())

# Plot settings
cbPalette     <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
kitchenColour <- c(cbPalette[2], cbPalette[3])
expColour     <- cbPalette[5:8]
mrcColour     <- '#77685C' # MRC colour 77685C
axisText      <- 20
legendText    <- 15
annotateSize  <- 5
```

# General stuff
In order to test my hypothesis. I thought to use the BRMS function hypothesis. For point hypotheses, this function calculates the Savage-Dickey density ratio method. I am following this example [here](https://vuorre.netlify.com/post/2017/03/21/bayes-factors-with-brms/). 

```{r}
xValues      <- seq(0, 1, by = .01)
priorDen     <- data.frame(x = xValues, prior = dbeta(xValues, 1, 1))
posteriorDen <- data.frame(x = xValues, posterior = dbeta(xValues, 10, 2))

p1 <- dbeta(0.5, 1, 1)
p2 <- dbeta(0.5, 10, 2)

# The BF10 is now just
1/(p2/p1)
```



```{r}
load("U:/Projects/schemaVR/schemaVR4/bayesianMM_recall_twolines_20190730_110220.RData")
hypothesis(schemaVR3_recall_twolines, "xhigh = 0")

# Normal
normalDen    <- data.frame(prior = rnorm(4000, schemaVR2_recall_twolines_fixef[3,1], schemaVR2_recall_twolines_fixef[3,2]),
                           posterior = rnorm(4000, schemaVR3_recall_twolines_fixef[3,1], schemaVR3_recall_twolines_fixef[3,2]))


Experiment <- c(rep(' Exp 2',length(schemaVR2_recall_twolines_postDen$b_xhigh)),
                rep(' Exp 3',length(schemaVR3_recall_twolines_postDen$b_xhigh)),
                rep(' Normal 2',length(normalDen$prior)),
                rep(' Normal 3',length(normalDen$posterior)))
Values     <- c(schemaVR2_recall_twolines_postDen$b_xhigh,
                schemaVR3_recall_twolines_postDen$b_xhigh,
                normalDen$prior,
                normalDen$posterior)
postDen_recall_twolines <- data.frame(Experiment = Experiment,
                                      values = Values)

# Get values for lines
yMax                     <- max(density(schemaVR3_recall_twolines_postDen$b_xhigh)$y)

# Plot
ggplot(postDen_recall_twolines, aes(x = values, fill = Experiment)) + 
  geom_vline(xintercept = c(0), linetype ="dotted", size = 1) +
  geom_density(alpha = 0.5) + 
  coord_cartesian(ylim = c(0, yMax*1.3), expand = FALSE) +
  labs(y = 'Density',
       x = 'Slope high') +
  scale_fill_manual(values = expColour) +
  theme(plot.margin = unit(c(1,1,1,1), "lines"),
        legend.position = c(1, 1),
        legend.justification = c(1, 1),
        legend.key.size = unit(0.5, "cm"),
        legend.title = element_blank(),
        axis.title = element_text(size = axisText),
        legend.text = element_text(size = legendText))
```

As can be seen above, the posterior nively follow normal distributions. Therefore, I will use the dnorm function to calculate the ratio. 

```{r}

p1    <- dnorm(0, schemaVR2_recall_twolines_fixef[3,1], schemaVR2_recall_twolines_fixef[3,2])
p2    <- dnorm(0, schemaVR3_recall_twolines_fixef[3,1], schemaVR3_recall_twolines_fixef[3,2])
pNull <- dnorm(0, 0, schemaVR2_recall_twolines_fixef[3,2])

# BF01
p2/p1

# BF10
1/(p2/p1)

# BF10
1/(p2/pNull)
```



```{r}
shift          <- 0.5
sharpen        <- 1.59893
postDenMean1  <- schemaVR2_recall_twolines_fixef[3,1] - shift
postDenMean2  <- schemaVR2_recall_twolines_fixef[3,1]
postDenMean3  <- schemaVR2_recall_twolines_fixef[3,1] + shift
postDenSD     <- schemaVR2_recall_twolines_fixef[3,2]/sharpen

# Calculate points
priorDenPoint1 <- dnorm(0, schemaVR2_recall_twolines_fixef[3,1], schemaVR2_recall_twolines_fixef[3,2])
postDenPoint1  <- dnorm(0, postDenMean1, postDenSD)
postDenPoint2  <- dnorm(0, postDenMean2, postDenSD)
postDenPoint3  <- dnorm(0, postDenMean3, postDenSD)


exampleDenPoints <- data.frame(Distribution = c('Prior', 'Post 1', 'Post 2', 'Post 3'),
                               x = c(0, 0, 0, 0),
                               Density = c(priorDenPoint1,
                                           postDenPoint1,
                                           postDenPoint2,
                                           postDenPoint3))

exampleBF <- data.frame(Case = c('Case 1', 'Case 2', 'Case 3'),
                        BF10 = c(1/(postDenPoint1/priorDenPoint1), 1/(postDenPoint2/priorDenPoint1), 1/(postDenPoint3/priorDenPoint1)))



xValues <- seq(-.5, 3, by = .01)
exampleDensityCurves <- data.frame(Distribution = c(rep('Prior', length(xValues)), 
                                                    rep('Post 1', length(xValues)),
                                                    rep('Post 2', length(xValues)),
                                                    rep('Post 3', length(xValues))),
                                   Parameter = xValues,
                                   Density =c(dnorm(xValues, schemaVR2_recall_twolines_fixef[3,1], schemaVR2_recall_twolines_fixef[3,2]),
                                              dnorm(xValues, postDenMean1, postDenSD),
                                              dnorm(xValues, postDenMean2, postDenSD),
                                              dnorm(xValues, postDenMean3, postDenSD)))


examplePlot <- ggplot(exampleDensityCurves, aes(x = Parameter, y = Density, colour = Distribution)) +
  geom_line() +
  theme(legend.position = c(1, 1),
        legend.justification = c(1, 1))

exampleZoomPlot <- ggplot(exampleDensityCurves, aes(x = Parameter, y = Density, colour = Distribution)) +
  geom_line() +
  geom_point(data = exampleDenPoints, aes(x = x, y = Density, colour = Distribution)) +
  annotate('text', x = 0, y = postDenPoint1-0.0001, label = as.character(round(postDenPoint1, 6))) +
  annotate('text', x = 0, y = priorDenPoint1-0.0001, label = as.character(round(priorDenPoint1, 6))) +
  coord_cartesian(ylim = c(0,
                           max(exampleDenPoints$Density)*1.1),
                  xlim = c(-0.1,
                           0.1),
                  expand = FALSE) +
  theme(legend.position = "none")

plot_grid(examplePlot, exampleZoomPlot)
```



```{r, include = FALSE}
# Loading data
load("U:/Projects/schemaVR/schemaVR4/findingAnalysis_20190729_190414.RData")
```


# U-Shape 
## Quadratic term
### Analysis of previous experiments
```{r}
# Current evidence ratios 
ratios1 <- data.frame(Experiment = c('schemaVR2', 'schemaVR3', 'combined'),
                      BF01 = c(schemaVR3_recall_ratio, schemaVR2_recall_ratio, (schemaVR3_recall_ratio * schemaVR2_recall_ratio)),
                      BF10 = c(1/schemaVR3_recall_ratio, 1/schemaVR2_recall_ratio, 1/(schemaVR3_recall_ratio * schemaVR2_recall_ratio)))


kable(ratios1)

# Information for priors
kable(schemaVR3_recall_fixef)
```

Now, I simulated data for two cases: data that is similar to schemaVR1 and schemaVR2 (case 1) and data where the true effect is zero (case 2).

### Case 1
#### Coefficients
```{r}
# LMER results
kable(createResultTable(recall_case1_model_lmer))

# BRMS results
kable(recall_case1_fixef)
```

#### Posterior distribution
```{r}
####################################
# Plot posterior distributions
# Recall accuracy
# Extracting values
Experiment <- c(rep(' Exp 1',length(schemaVR1_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)),
                rep(' Exp 2',length(schemaVR2_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)),
                rep(' Exp 3',length(schemaVR3_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)),
                rep(' Case 1',length(recall_case1_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)))
Values     <- c(schemaVR1_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating,
                schemaVR2_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating,
                schemaVR3_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating,
                recall_case1_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)
postDen_recall_quad_eff <- data.frame(Experiment = Experiment,
                                      values = Values)

# Get values for lines
yMax                     <- max(density(recall_case1_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)$y)
recall_case1_effM_CI     <- as.numeric(recall_case1_fixef[3,3:4])

# Plot
ggplot(postDen_recall_quad_eff, aes(x = values, fill = Experiment)) + 
  geom_vline(xintercept = c(0), linetype ="dotted", size = 1) +
  geom_density(alpha = 0.5) + 
  geom_segment(x = recall_case1_effM_CI[1],
               y = 0,
               xend = recall_case1_effM_CI[1],
               yend = yMax,
               colour = 'black') +
  geom_segment(x = recall_case1_effM_CI[2],
               y = 0,
               xend = recall_case1_effM_CI[2],
               yend = yMax,
               colour = 'black') +
  geom_segment(x = recall_case1_effM_CI[1],
               y = yMax*1.065,
               xend = recall_case1_effM_CI[2],
               yend = yMax*1.065,
               colour = 'black',
               arrow = arrow(ends = "both", length = unit(0.2, "cm"))) +
  annotate("text", x = mean(recall_case1_effM_CI), y = yMax*1.1, label = "95 % CI") +
  coord_cartesian(ylim = c(0, yMax*1.3), expand = FALSE) +
  labs(y = 'Density',
       x = 'Quadratic term') +
  scale_fill_manual(values = expColour) +
  theme(plot.margin = unit(c(1,1,1,1), "lines"),
        legend.position = c(1, 1),
        legend.justification = c(1, 1),
        legend.key.size = unit(0.5, "cm"),
        legend.title = element_blank(),
        axis.title = element_text(size = axisText),
        legend.text = element_text(size = legendText))
```

#### Evidence ratios
```{r}
# Evidence ratios in case 1
ratios2 <- data.frame(Experiment = c('schemaVR2', 
                                     'schemaVR3', 
                                     'case 1', 
                                     'combined'),
                      BF01 = c(schemaVR2_recall_ratio, 
                               schemaVR3_recall_ratio, 
                               recall_case1_ratio, 
                               (schemaVR2_recall_ratio * schemaVR3_recall_ratio * recall_case1_ratio)),
                      BF10 = c(1/schemaVR2_recall_ratio, 
                               1/schemaVR3_recall_ratio, 
                               1/recall_case1_ratio,
                               1/(schemaVR2_recall_ratio * schemaVR3_recall_ratio * recall_case1_ratio)))


kable(ratios2)
```

### Case 2
#### Coefficients
```{r}
# LMER results
kable(createResultTable(recall_case2_model_lmer))

# BRMS results
kable(recall_case2_fixef)
```

#### Posterior distribution
```{r}
####################################
# Plot posterior distributions
# Recall accuracy
# Extracting values
Experiment <- c(rep(' Exp 1',length(schemaVR1_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)),
                rep(' Exp 2',length(schemaVR2_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)),
                rep(' Exp 3',length(schemaVR3_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)),
                rep(' Case 2',length(recall_case2_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)))
Values     <- c(schemaVR1_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating,
                schemaVR2_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating,
                schemaVR3_recall_postDen$b_IobjLocTargetRatingMUobjLocTargetRating,
                recall_case2_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)
postDen_recall_quad_eff <- data.frame(Experiment = Experiment,
                                      values = Values)

# Get values for lines
yMax                     <- max(density(recall_case2_postDen$b_IobjLocTargetRatingMUobjLocTargetRating)$y)
recall_case2_effM_CI     <- as.numeric(recall_case2_fixef[3,3:4])

# Plot
ggplot(postDen_recall_quad_eff, aes(x = values, fill = Experiment)) + 
  geom_vline(xintercept = c(0), linetype ="dotted", size = 1) +
  geom_density(alpha = 0.5) + 
  geom_segment(x = recall_case2_effM_CI[1],
               y = 0,
               xend = recall_case2_effM_CI[1],
               yend = yMax,
               colour = 'black') +
  geom_segment(x = recall_case2_effM_CI[2],
               y = 0,
               xend = recall_case2_effM_CI[2],
               yend = yMax,
               colour = 'black') +
  geom_segment(x = recall_case2_effM_CI[1],
               y = yMax*1.065,
               xend = recall_case2_effM_CI[2],
               yend = yMax*1.065,
               colour = 'black',
               arrow = arrow(ends = "both", length = unit(0.2, "cm"))) +
  annotate("text", x = mean(recall_case2_effM_CI), y = yMax*1.1, label = "95 % CI") +
  coord_cartesian(ylim = c(0, yMax*1.3), expand = FALSE) +
  labs(y = 'Density',
       x = 'Quadratic term') +
  scale_fill_manual(values = expColour) +
  theme(plot.margin = unit(c(1,1,1,1), "lines"),
        legend.position = c(1, 1),
        legend.justification = c(1, 1),
        legend.key.size = unit(0.5, "cm"),
        legend.title = element_blank(),
        axis.title = element_text(size = axisText),
        legend.text = element_text(size = legendText))
```

#### Evidence ratios
```{r}
# Evidence ratios in case 1
ratios3 <- data.frame(Experiment = c('schemaVR2', 
                                     'schemaVR3', 
                                     'case 2', 
                                     'combined'),
                      BF01 = c(schemaVR2_recall_ratio, 
                               schemaVR3_recall_ratio, 
                               recall_case2_ratio, 
                               (schemaVR2_recall_ratio * schemaVR3_recall_ratio * recall_case2_ratio)),
                      BF10 = c(1/schemaVR2_recall_ratio, 
                               1/schemaVR3_recall_ratio, 
                               1/recall_case2_ratio,
                               1/(schemaVR2_recall_ratio * schemaVR3_recall_ratio * recall_case2_ratio)))


kable(ratios3)
```

## Two line test

Before I start the two-line test it's important to check how different the minima of the quadratic terms are. 
```{r}
minima <- data.frame(Experiment = c('schemaVR1', 
                                    'schemaVR2', 
                                    'schemaVR3'),
                     Minimum = c(quadMin(schemaVR1_recall_fixef[3, 1], schemaVR1_recall_fixef[2, 1]),
                                 quadMin(schemaVR2_recall_fixef[3, 1], schemaVR1_recall_fixef[2, 1]),
                                 quadMin(schemaVR3_recall_fixef[3, 1], schemaVR1_recall_fixef[2, 1])))

meanMinimum <- mean(minima$Minimum)

kable(minima)
```

I will there use the value of schemaVR3 of the `r meanMinimum` as the breaking point for all analyses. I based on the average of the BRMS estimates. 


# Recollection
## Analysis of previous experiments
```{r}
# Current evidence ratios 
ratios6 <- data.frame(Experiment = c('schemaVR3'),
                      BF01 = c(schemaVR3_rec_AFC_ratio),
                      BF10 = c(1/schemaVR3_rec_AFC_ratio))


kable(ratios6)

# Information for priors
kable(schemaVR3_rec_AFC_fixef)
```


## Case 1
```{r}
# LMER results
kable(createResultTable(rk_case1_model_lmer))

# BRMS results
kable(rk_case1_fixef)
```

#### Posterior distribution
```{r}
####################################
# Plot posterior distributions
# Recall accuracy
# Extracting values
Experiment <- c(rep(' Exp 2',length(schemaVR2_rec_AFC_postDen$b_objLocTargetRating)),
                rep(' Exp 3',length(schemaVR3_rec_AFC_postDen$b_objLocTargetRating)),
                rep(' Case 1',length(rk_case1_postDen$b_objLocTargetRating)))
Values     <- c(schemaVR2_rec_AFC_postDen$b_objLocTargetRating,
                schemaVR3_rec_AFC_postDen$b_objLocTargetRating,
                rk_case1_postDen$b_objLocTargetRating)
postDen_rec_AFC_eff <- data.frame(Experiment = Experiment,
                                      values = Values)

# Get values for lines
yMax                     <- max(density(rk_case1_postDen$b_objLocTargetRating)$y)
recall_case1_effM_CI     <- as.numeric(rk_case1_fixef[2,3:4])

# Plot
ggplot(postDen_rec_AFC_eff, aes(x = values, fill = Experiment)) + 
  geom_vline(xintercept = c(0), linetype ="dotted", size = 1) +
  geom_density(alpha = 0.5) + 
  geom_segment(x = recall_case1_effM_CI[1],
               y = 0,
               xend = recall_case1_effM_CI[1],
               yend = yMax,
               colour = 'black') +
  geom_segment(x = recall_case1_effM_CI[2],
               y = 0,
               xend = recall_case1_effM_CI[2],
               yend = yMax,
               colour = 'black') +
  geom_segment(x = recall_case1_effM_CI[1],
               y = yMax*1.065,
               xend = recall_case1_effM_CI[2],
               yend = yMax*1.065,
               colour = 'black',
               arrow = arrow(ends = "both", length = unit(0.2, "cm"))) +
  annotate("text", x = mean(recall_case1_effM_CI), y = yMax*1.1, label = "95 % CI") +
  coord_cartesian(ylim = c(0, yMax*1.3), expand = FALSE) +
  labs(y = 'Density',
       x = 'Quadratic term') +
  scale_fill_manual(values = expColour) +
  theme(plot.margin = unit(c(1,1,1,1), "lines"),
        legend.position = c(1, 1),
        legend.justification = c(1, 1),
        legend.key.size = unit(0.5, "cm"),
        legend.title = element_blank(),
        axis.title = element_text(size = axisText),
        legend.text = element_text(size = legendText))
```

#### Evidence ratios
```{r}
# Evidence ratios in case 1
ratios7 <- data.frame(Experiment = c('schemaVR3', 'case 1', 'combined'),
                      BF01 = c(schemaVR3_rec_AFC_ratio, rk_case1_ratio, schemaVR3_rec_AFC_ratio*rk_case1_ratio),
                      BF10 = c(1/schemaVR3_rec_AFC_ratio, 1/rk_case1_ratio, 1/(schemaVR3_rec_AFC_ratio*rk_case1_ratio)))


kable(ratios7)
```

## Case 2
```{r}
# LMER results
kable(createResultTable(rk_case2_model_lmer))

# BRMS results
kable(rk_case2_fixef)
```

#### Posterior distribution
```{r}
####################################
# Plot posterior distributions
# Recall accuracy
# Extracting values
Experiment <- c(rep(' Exp 2',length(schemaVR2_rec_AFC_postDen$b_objLocTargetRating)),
                rep(' Exp 3',length(schemaVR3_rec_AFC_postDen$b_objLocTargetRating)),
                rep(' Case 2',length(rk_case2_postDen$b_objLocTargetRating)))
Values     <- c(schemaVR2_rec_AFC_postDen$b_objLocTargetRating,
                schemaVR3_rec_AFC_postDen$b_objLocTargetRating,
                rk_case2_postDen$b_objLocTargetRating)
postDen_rec_AFC_eff <- data.frame(Experiment = Experiment,
                                      values = Values)

# Get values for lines
yMax                     <- max(density(rk_case2_postDen$b_objLocTargetRating)$y)
recall_case2_effM_CI     <- as.numeric(rk_case2_fixef[2,3:4])

# Plot
ggplot(postDen_rec_AFC_eff, aes(x = values, fill = Experiment)) + 
  geom_vline(xintercept = c(0), linetype ="dotted", size = 1) +
  geom_density(alpha = 0.5) + 
  geom_segment(x = recall_case2_effM_CI[1],
               y = 0,
               xend = recall_case2_effM_CI[1],
               yend = yMax,
               colour = 'black') +
  geom_segment(x = recall_case2_effM_CI[2],
               y = 0,
               xend = recall_case2_effM_CI[2],
               yend = yMax,
               colour = 'black') +
  geom_segment(x = recall_case2_effM_CI[1],
               y = yMax*1.065,
               xend = recall_case2_effM_CI[2],
               yend = yMax*1.065,
               colour = 'black',
               arrow = arrow(ends = "both", length = unit(0.2, "cm"))) +
  annotate("text", x = mean(recall_case2_effM_CI), y = yMax*1.1, label = "95 % CI") +
  coord_cartesian(ylim = c(0, yMax*1.3), expand = FALSE) +
  labs(y = 'Density',
       x = 'Quadratic term') +
  scale_fill_manual(values = expColour) +
  theme(plot.margin = unit(c(1,1,1,1), "lines"),
        legend.position = c(1, 1),
        legend.justification = c(1, 1),
        legend.key.size = unit(0.5, "cm"),
        legend.title = element_blank(),
        axis.title = element_text(size = axisText),
        legend.text = element_text(size = legendText))
```

#### Evidence ratios
```{r}
# Evidence ratios in case 1
ratios7 <- data.frame(Experiment = c('schemaVR3', 'case 2', 'combined'),
                      BF01 = c(schemaVR3_rec_AFC_ratio, rk_case2_ratio, schemaVR3_rec_AFC_ratio*rk_case2_ratio),
                      BF10 = c(1/schemaVR3_rec_AFC_ratio, 1/rk_case2_ratio, 1/(schemaVR3_rec_AFC_ratio*rk_case2_ratio)))


kable(ratios7)
```